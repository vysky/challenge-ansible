# turning the concept (create, moving and deleting files) of this lab into ansible playbook
# https://learn.acloud.guru/handson/8d1946ab-3035-4e5f-b735-d662fc761482/course/87e08bad-9655-4a7c-9f07-5dd44149b837

---
  - hosts: localhost
    become: yes
    vars:
      var_workingdir: ~/Downloads/github/challenge-ansible/challenge-1
      var_devdir: "{{ var_workingdir }}/1-dev"
      var_stagingdir: "{{ var_workingdir }}/2-staging"
      var_proddir: "{{ var_workingdir }}/3-prod"
    vars_files:
      - "{{ var_workingdir }}/files.txt"
    tasks:
    - name: task 1
      # refer to https://docs.ansible.com/ansible/latest/user_guide/playbooks_blocks.html
      block:
        - name: task 1 - check if dev directory exist
          stat:
            path: "{{ var_devdir }}"
          register: stat_devdir_exist
      rescue:
        - name: task 1 - error
          debug:
            msg: "task 1 error"
      always:
        - name: task 1 - logging
          shell: echo "task 1 completed" > logs.txt
    - name: task 2
      block:
        - name: task 2 - create files directory
          file:
            path: "{{ var_devdir }}"
            # refer to https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html#parameter-state
            state: directory
          when: not stat_devdir_exist.stat.exists
      rescue:
        - name: task 2 - error
          debug:
            msg: "task 2 error"
      always:
        - name: task 2 - logging
          shell: echo "task 2 completed" >> logs.txt
    - name: task 3
      block:
        # create files based on the items in files.txt
        - name: task 3 - create files
          file:
            path: "{{ var_devdir }}/{{ item }}"
            # refer to https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html#parameter-state
            state: touch
          # refer to https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html
          loop: "{{ files }}"
          notify: test
      rescue:
        - name: task 3 - error
          debug:
            msg: "task 3 error"
      always:
        - name: task 3 - logging
          shell: echo "task 3 completed" >> logs.txt
    - name: task 4
      block:
        - name: task 4 - check if stage directory exist
          stat:
            path: "{{ var_stagingdir }}"
          register: stat_stagingdir_exist
      rescue:
        - name: task 4 - error
          debug:
            msg: "task 4 error"
      always:
        - name: task 4 - logging
          shell: echo "task 4 completed" >> logs.txt
    - name: task 5
      block:
        - name: task 5 - create staging directory
          file:
            path: "{{ var_stagingdir }}"
            state: directory
          when: not stat_stagingdir_exist.stat.exists
      rescue:
        - name: task 5 - error
          debug:
            msg: "task 5 error"
      always:
        - name: task 5 - logging
          shell: echo "task 5 completed" >> logs.txt
    - name: task 6
      block:
        # copy files using ansible built in copy command
        - name: task 6 - copy files from dev to staging
          copy:
            src: "{{ item }}"
            dest: "{{ var_stagingdir }}"
            # refer to https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html
            remote_src: yes
          # refer to https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fileglob_lookup.html
          with_fileglob:
            - "{{ var_devdir }}/*"
      rescue:
        - name: task 6 - error
          debug:
            msg: "task 6 error"
      always:
        - name: task 6 - logging
          shell: echo "task 6 completed" >> logs.txt
    - name: task 7
      block:
        - name: task 7 - check if prod direcotry exist
          stat:
            path: "{{ var_proddir }}"
          register: stat_proddir_exist
      rescue:
        - name: task 7 - error
          debug:
            msg: "task 7 error"
      always:
        - name: task 7 - logging
          shell: echo "task 7 completed" >> logs.txt
    - name: task 8
      block:
        - name: task 8 - create prod directory
          file:
            path: "{{ var_proddir }}"
            state: directory
          when: not stat_proddir_exist.stat.exists
      rescue:
        - name: task 8 - error
          debug:
            msg: "task 8 error"
      always:
        - name: task 8 - logging
          shell: echo "task 8 completed" >> logs.txt
    - name: task 9
      block:
        # copy files using shell command
        - name: task 9 - copy files from staging to prod
          shell: "cp {{ var_stagingdir }}/* {{ var_proddir }}"
      rescue:
        - name: task 9 - error
          debug:
            msg: "task 9 error"
      always:
        - name: task 9 - logging
          shell: echo "task 9 completed" >> logs.txt
    - name: task 10
      block:
        - name: task 10 - delete created files and directories
          file:
            path: "{{ item }}"
            # refer to https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html#parameter-state
            state: absent
          # refer to https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html
          # and https://docs.ansible.com/ansible/latest/collections/ansible/builtin/items_lookup.html
          with_items:
          - "{{ var_devdir }}"
          - "{{ var_stagingdir }}"
          - "{{ var_proddir }}"
          - logs.txt
      rescue:
        - name: task 10 - error
          debug:
            msg: "task 10 error"
      always:
        - name: task 10 - logging
          debug:
            msg: "deleted"
    handlers:
    - name: display message
      debug:
        msg: "created files"
      listen: test